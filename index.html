<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LN Finisher — Beautiful UI</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-900:#0b1020;
      --bg-800:#0f1724;
      --panel:#0f1727;
      --glass: rgba(255,255,255,0.03);
      --muted: #9aa4b2;
      --accent:#007aff;           /* Duolingo-pro blue accent */
      --accent-2: #00d084;       /* greenish accent */
      --card-glow: 0 10px 30px rgba(2,6,23,0.6);
      --radius:14px;
      --glass-border: rgba(255,255,255,0.04);
      --glass-strong: rgba(255,255,255,0.06);
      --text: #e6eef8;
      --sub: #b7c3d6;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-900),var(--bg-800));font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    /* center frame */
    .app-wrap{max-width:1100px;margin:28px auto;padding:28px;display:grid;grid-template-columns:360px 1fr 340px;gap:20px;align-items:start;}
    /* Left column (controls) */
    .side {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--card-glow);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(8px) saturate(120%);
      color:var(--text);
    }
    .brand {
      display:flex;gap:12px;align-items:center;margin-bottom:12px;
    }
    .brand .logo {
      width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:white;font-size:20px;box-shadow:0 6px 18px rgba(0,122,255,0.14), inset 0 -8px 30px rgba(255,255,255,0.04);
    }
    .brand h1{margin:0;font-size:16px;font-weight:700;letter-spacing:0.2px}
    .brand p{margin:0;font-size:12px;color:var(--sub)}
    /* Login panel */
    .panel { margin-top:10px; border-radius:12px; padding:14px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid var(--glass-border); }
    label.small { font-size:12px;color:var(--sub);display:block;margin-bottom:6px; }
    input[type="text"], input[type="password"], input[type="range"]{
      width:100%; padding:12px 12px;border-radius:10px;border:1px solid var(--glass-border); background:rgba(255,255,255,0.02); color:var(--text); font-size:14px; box-sizing:border-box;
    }
    button.primary {
      width:100%; padding:12px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent),#2aa7ff); color:white;font-weight:700; font-size:15px;cursor:pointer;box-shadow:0 8px 24px rgba(0,122,255,0.12);
    }
    .small-btn { display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid var(--glass-border);background:rgba(255,255,255,0.02);color:var(--text);cursor:pointer;font-weight:600;}
    .muted { color:var(--sub); font-size:13px; }
    .usage { text-align:center;margin-top:8px;font-size:13px;color:var(--sub); }

    /* Center column (homeworks) */
    .center {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--card-glow);
      border:1px solid var(--glass-border);
      min-height:380px;
      color:var(--text);
    }
    .center h2{margin:0 0 10px 0;font-size:18px}
    .hw-list { max-height:520px; overflow:auto; padding-right:10px; }
    .hw-card { border-radius:12px;padding:10px;margin-bottom:10px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.02); display:block; }
    .hw-card .title { display:flex;gap:8px;align-items:center }
    .hw-card .title b{font-weight:700}
    .task { padding:8px 6px;border-radius:8px;margin-top:6px;display:flex;align-items:center;gap:8px; }
    label.task-label { color:var(--text); font-size:14px; }

    /* Right column (logs and settings) */
    .logs {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--card-glow);
      border:1px solid var(--glass-border);
      color:var(--text);
      min-height:380px;
    }
    .progress-wrap{margin:8px 0 14px 0}
    .progress { height:12px;border-radius:8px;background:rgba(255,255,255,0.03);overflow:hidden;border:1px solid rgba(255,255,255,0.02);}
    .progress > .bar { height:100%; width:0%; background:linear-gradient(90deg,var(--accent),#4dd2ff); transition: width .5s ease; }

    .log-area { max-height:360px; overflow:auto;padding:8px;border-radius:10px;background:rgba(255,255,255,0.015); border:1px solid rgba(255,255,255,0.02); color:var(--sub); font-size:13px; }

    /* top controls */
    .top-controls { display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-bottom:12px; }
    .top-controls .icon-btn { width:44px; height:44px; border-radius:12px; display:inline-flex;align-items:center;justify-content:center; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid var(--glass-border); cursor:pointer; color:var(--accent); }

    /* responsive */
    @media (max-width: 980px){
      .app-wrap{grid-template-columns: 1fr;padding:18px;}
      .side, .center, .logs { margin-bottom:14px; }
    }
  </style>
</head>
<body>
  <div class="app-wrap">
    <!-- LEFT: Login + quick actions -->
    <div class="side" id="left_col">
      <div class="brand">
        <div class="logo">LN</div>
        <div>
          <h1>LN Finisher</h1>
          <p>Automation helper — beautiful UI</p>
        </div>
      </div>

      <div class="panel" id="login_panel">
        <label class="small">Username</label>
        <input id="username_input" type="text" placeholder="Username">
        <label class="small">Password</label>
        <input id="password_input" type="password" placeholder="Password">
        <div style="height:10px"></div>
        <button id="login_btn" class="primary">Log in</button>
        <div class="usage" style="margin-top:12px">
          Successfully completed by <b id="usage_count">...</b> users!
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="panel" style="display:flex;flex-direction:column;gap:10px">
        <div style="display:flex;gap:10px;">
          <button id="settings_button" class="small-btn">⚙ Settings</button>
          <button id="do_hw" class="small-btn" style="background:linear-gradient(90deg,var(--accent),#4dd2ff);color:white;border:none">Start</button>
        </div>
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div class="muted">Speed</div>
          <div style="width:60%;text-align:right;color:var(--sub)" id="speed_display">—</div>
        </div>
        <input id="speed_slider" type="range" min="-3" max="18" value="2" step="0.1">
      </div>
    </div>

    <!-- CENTER: Homeworks -->
    <div class="center" id="center_col">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Homeworks</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" id="selectall"/>
          <label for="selectall" style="color:var(--sub);font-weight:600">Select all</label>
        </div>
      </div>

      <div id="hw_container" class="hw-list" aria-live="polite">
        <!-- dynamically filled by your JS -->
        <div style="opacity:0.4">No homeworks loaded yet — log in to fetch them</div>
      </div>
    </div>

    <!-- RIGHT: Logs -->
    <div class="logs" id="right_col">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0">Logs</h2>
        <div class="muted">Realtime</div>
      </div>

      <div class="progress-wrap">
        <div class="progress">
          <div id="hw_bar" class="bar"></div>
        </div>
      </div>

      <div id="log_container" class="log-area">Logs will appear here...</div>
    </div>
  </div>

  <!-- Settings dialog (keeps your IDs) -->
  <dialog id="settings" style="border:none;padding:20px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:var(--text);backdrop-filter: blur(8px);">
    <button id="close_settings_btn" style="position:absolute;right:12px;top:10px;background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer">&times;</button>
    <h3 style="margin-top:6px">Settings</h3>
    <p class="muted">Adjust the completion time per task</p>
    <input id="speed_slider" type="range" min="-3" max="18" value="2" step="0.1">
    <p style="color:var(--sub)">Current speed: <span id="speed_display">—</span></p>
    <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
      <label class="small">Light / Dark</label>
      <label style="display:inline-flex;align-items:center;gap:8px">
        <input id="theme_toggle" type="checkbox"> Dark
      </label>
    </div>
  </dialog>

  <!-- Your original JS (kept intact) -->
  <script>
/* ---------------------------
   YOUR JAVASCRIPT (unchanged)
   pasted exactly from what you provided
   --------------------------- */

speed = 10000;
document.getElementById("settings_button").addEventListener("click", () => {
    document.getElementById("settings").showModal();
});
speed_input = document.getElementById("speed_slider");
speed_input.oninput = function () {
    console.log("change", this);
    speed = 10 ** this.value;
    console.log(speed, this.value);
    document.getElementById("speed_display").innerText = secondsToString(speed);
};

function secondsToString(seconds) {
    const numyears = Math.floor(seconds / 31536000);
    const numdays = Math.floor((seconds % 31536000) / 86400);
    const numhours = Math.floor(((seconds % 31536000) % 86400) / 3600);
    const numminutes = Math.floor((((seconds % 31536000) % 86400) % 3600) / 60);
    const numseconds = (((seconds % 31536000) % 86400) % 3600) % 60;
    return `${numyears} years ${numdays} days ${numhours} hours ${numminutes} minutes ${numseconds} seconds`;
}

function set_checkboxes(node, state) {
    console.log(node);
    const container = document.getElementById(node);
    for (const checkbox of container.querySelectorAll("input[type=checkbox]")) {
        checkbox.checked = state;
    }
}

// from https://gist.github.com/jzohrab/a6701d0087edca8303ec069826ec4b14
async function asyncPool(array, poolSize) {
    const result = [];
    const pool = [];

    // Promises leave the pool when they're resolved.
    function leavePool(e) {
        pool.splice(pool.indexOf(e), 1);
    }

    for (const item of array) {
        const p = Promise.resolve(item());
        result.push(p);
        const e = p.then(() => leavePool(e));
        pool.push(e);
        if (pool.length >= poolSize) await Promise.race(pool);
    }
    return Promise.all(result);
}

class task_completer {
    constructor(token, task, ietf) {
        this.token = token;
        this.task = task;

        this.mode = this.get_task_type();
        this.to_language = ietf;
        this.cataloguid;

        this.homework_id = task.base[0];
        this.catalog_uid = task.catalog_uid;
        if (this.catalog_uid === undefined)
            this.catalog_uid = task.base[task.base.length - 1];
        this.rel_module_uid = task.rel_module_uid;
        this.game_uid = task.game_uid;
        this.game_type = task.type;
    }

    async complete() {
        const answers = await this.get_data();
        console.log(answers);
        await this.send_answers(answers);
    }
    async get_data() {
        let vocabs;
        if (this.mode === "sentence") vocabs = await this.get_sentences();
        if (this.mode === "verbs") vocabs = await this.get_verbs();
        if (this.mode === "phonics") vocabs = await this.get_phonics();
        if (this.mode === "exam") vocabs = await this.get_exam();
        if (this.mode === "vocabs") vocabs = await this.get_vocabs();
        return vocabs;
    }
    async send_answers(vocabs) {
        console.log(vocabs);
        if (vocabs === undefined || vocabs.length === 0) {
            console.log("No vocabs found, skipping sending answers.");
            return; // Stop the function if no vocabs are found
        }
        const data = {
            moduleUid: this.catalog_uid,
            gameUid: this.game_uid,
            gameType: this.game_type,
            isTest: true,
            toietf: this.to_language,
            fromietf: "en-US",
            score: vocabs.length * 200,
            correctVocabs: vocabs.map((x) => x.uid).join(","),
            incorrectVocabs: [],
            homeworkUid: this.homework_id,
            isSentence: this.mode === "sentence",
            isALevel: false,
            isVerb: this.mode === "verbs",
            verbUid: this.mode === "verbs" ? this.catalog_uid : "",
            phonicUid: this.mode === "phonics" ? this.catalog_uid : "",
            sentenceScreenUid: this.mode === "sentence" ? 100 : "",

            sentenceCatalogUid:
                this.mode === "sentence" ? this.catalog_uid : "",
            grammarCatalogUid: this.catalog_uid,
            isGrammar: false,
            isExam: this.mode === "exam",
            correctStudentAns: "",
            incorrectStudentAns: "",
            timeStamp:
                Math.floor(speed + ((Math.random() - 0.5) / 10) * speed) * 1000,
            vocabNumber: vocabs.length,
            rel_module_uid: this.task.rel_module_uid,
            dontStoreStats: true,
            product: "secondary",
            token: this.token,
        };
        console.log(data);
        const response = await this.call_lnut(
            "gameDataController/addGameScore",
            data,
        );
        return response;
    }

    async get_verbs() {
        const vocabs = await this.call_lnut(
            "verbTranslationController/getVerbTranslations",
            {
                verbUid: this.catalog_uid,
                toLanguage: this.to_language,
                fromLanguage: "en-US",
                token: this.token,
            },
        );
        return vocabs.verbTranslations;
    }
    async get_phonics() {
        const vocabs = await this.call_lnut(
            "phonicsController/getPhonicsData",
            {
                phonicCatalogUid: this.catalog_uid,
                toLanguage: this.to_language,
                fromLanguage: "en-US",
                token: this.token,
            },
        );
        return vocabs.phonics;
    }
    async get_sentences() {
        const vocabs = await this.call_lnut(
            "sentenceTranslationController/getSentenceTranslations",
            {
                catalogUid: this.catalog_uid,
                toLanguage: this.to_language,
                fromLanguage: "en-US",
                token: this.token,
            },
        );
        return vocabs.sentenceTranslations;
    }
    async get_exam() {
        console.log(this.catalog_uid);
        const vocabs = await this.call_lnut(
            "examTranslationController/getExamTranslationsCorrect",
            {
                gameUid: this.game_uid,
                examUid: this.catalog_uid,
                toLanguage: this.to_language,
                fromLanguage: "en-US",
                token: this.token,
            },
        );
        return vocabs.examTranslations;
    }
    async get_vocabs() {
        const vocabs = await this.call_lnut(
            "vocabTranslationController/getVocabTranslations",
            {
                "catalogUid[]": this.catalog_uid,
                toLanguage: this.to_language,
                fromLanguage: "en-US",
                token: this.token,
            },
        );
        return vocabs.vocabTranslations;
    }

    async call_lnut(url, data) {
        const url_data = new URLSearchParams(data).toString();
        const response = await fetch(
            `https://api.languagenut.com/${url}?${url_data}`,
        );
        const json = await response.json();
        return json;
    }
    get_task_type() {
        console.log(this.task);
        if (this.task.gameLink.includes("sentenceCatalog")) return "sentence";
        if (this.task.gameLink.includes("verbUid")) return "verbs";
        if (this.task.gameLink.includes("phonicCatalogUid")) return "phonics";
        if (this.task.gameLink.includes("examUid")) return "exam";
        return "vocabs";
    }
}

class client_application {
    constructor() {
        this.username_box = document.getElementById("username_input");
        this.password_box = document.getElementById("password_input");
        this.module_translations = [];
        this.display_translations = [];
        this.homeworks = [];
    }

    hide_all() {
        const divsToHide = document.getElementsByClassName("overlay");
        for (let i = 0; i < divsToHide.length; i++) {
            divsToHide[i].style.visibility = "hidden"; // or
        }
    }

    show_box(id) {
        document.getElementById(id).style.visibility = "visible";
    }

    hide_box(id) {
        document.getElementById(id).style.visibility = "hidden";
    }

    async call_lnut(url, data) {
        const url_data = new URLSearchParams(data).toString();
        const response = await fetch(
            `https://api.languagenut.com/${url}?${url_data}`,
        );
        const json = await response.json();
        return json;
    }

    main() {
        this.show_box("login");
        document.getElementById("login_btn").onclick = async () => {
            const response = await this.call_lnut(
                "loginController/attemptLogin",
                {
                    username: this.username_box.value,
                    pass: this.password_box.value,
                },
            );
            this.token = response.newToken;
            if (this.token !== undefined) this.on_log_in();
        };
    }

    on_log_in() {
        this.hide_box("login");
        this.show_box("hw_panel");
        this.show_box("log_panel");
        document.getElementById("do_hw").onclick = () => {
            app.do_hwks();
        };
        this.get_module_translations();
        this.get_display_translations();
        this.display_hwks();
    }

    get_task_name(task) {
        let name = task.verb_name;

        if (task.module_translations !== undefined) {
            name = this.module_translations[task.module_translations[0]];
        }

        if (task.module_translation !== undefined) {
            name = this.module_translations[task.module_translation];
        }

        return name;
    }

    async display_hwks() {
        const homeworks = await this.get_hwks();
        const panel = document.getElementById("hw_container");
        panel.innerHTML = "";
        this.homeworks = homeworks.homework;
        this.homeworks.reverse();
        console.log(homeworks);

        const selbutton = document.getElementById("selectall");
        selbutton.onclick = function select_checkbox() {
            const selallcheckbox = document.getElementsByName("boxcheck");
            for (const checkbox of selallcheckbox)
                checkbox.checked = this.checked;
        };
        let hw_idx = 0;
        for (const homework of this.homeworks) {
            const { hw_name, hw_display } =
                this.create_homework_elements(homework, hw_idx);
            panel.appendChild(hw_name);
            panel.appendChild(hw_display);

            hw_idx++;
        }
    }
    create_homework_elements(homework, hw_idx) {
        const hw_checkbox = document.createElement("input");
        hw_checkbox.type = "checkbox";
        hw_checkbox.name = "boxcheck";
        hw_checkbox.onclick = function () {
            set_checkboxes(this.parentNode.nextElementSibling.id, this.checked);
        };
        const hw_name = document.createElement("span");
        hw_name.innerText = `${homework.name}`;
        hw_name.style.display = "block";

        hw_name.prepend(hw_checkbox);

        const hw_display = document.createElement("div");
        hw_display.id = `hw${homework.id}`;
        let idx = 0;
        for (const task of homework.tasks) {
            const { task_span, task_checkbox, task_display } =
                this.create_task_elements(task, hw_idx, idx);
            task_span.appendChild(task_checkbox);
            task_span.appendChild(task_display);
            task_span.appendChild(document.createElement("br"));

            hw_display.appendChild(task_span);
            idx++;
        }

        return { hw_name: hw_name, hw_display: hw_display };
    }
    create_task_elements(task, hw_idx, idx) {
        const task_checkbox = document.createElement("input");
        task_checkbox.type = "checkbox";
        task_checkbox.name = "boxcheck";
        task_checkbox.id = `${hw_idx}-${idx}`;

        const task_display = document.createElement("label");
        task_display.for = task_checkbox.id;
        const percentage = task.gameResults ? task.gameResults.percentage : "-";
        task_display.innerHTML = `${this.display_translations[task.translation]} - ${this.get_task_name(task)} (${percentage}%)`;

        const task_span = document.createElement("span");

        task_span.classList.add("task");

        return {
            task_span: task_span,
            task_checkbox: task_checkbox,
            task_display: task_display,
        };
    }

    async do_hwks() {
        const checkboxes = document.querySelectorAll(
            ".task > input[type=checkbox]:checked",
        );
        const logs = document.getElementById("log_container");
        logs.innerHTML = `doing ${checkboxes.length} tasks...<br>`;
        const progress_bar = document.getElementById("hw_bar");
        let task_id = 1;
        let progress = 0;
        progress_bar.style.width = "0%";
        const funcs = [];
        for (const c of checkboxes) {
            const parts = c.id.split("-");
            const task = this.homeworks[parts[0]].tasks[parts[1]];
            const task_doer = new task_completer(
                this.token,
                task,
                this.homeworks[parts[0]].languageCode,
            );
            funcs.push((x) =>
                (async (id) => {
                    const answers = await task_doer.get_data();
                    if (answers === undefined || answers.length === 0) {
                        console.log(
                            "No answers found, skipping sending answers.",
                        );
                        return; // Stop the function if no answers are found
                    }
                    logs.innerHTML += `<b>fetched vocabs for task ${id}</b>`;
                    logs.innerHTML += `<div class="json_small">${JSON.stringify(answers)}</div>`;
                    progress += 1;
                    progress_bar.style.width = `${String((progress / checkboxes.length) * 0.5 * 100)}%`;
                    console.log("Calling send_answers with answers:", answers);
                    const result = await task_doer.send_answers(answers);
                    logs.innerHTML += `<b>task ${id} done, scored ${result.score}</b>`;
                    logs.innerHTML += `<div class="json_small">${JSON.stringify(result)}</div>`;
                    logs.scrollTop = logs.scrollHeight;
                    progress += 1;
                    progress_bar.style.width = `${String((progress / checkboxes.length) * 0.5 * 100)}%`;
                })(task_id++),
            );
        }
        asyncPool(funcs, 5).then(() => {
            this.display_hwks();
        });
    }

    async get_display_translations() {
        this.display_translations = await this.call_lnut(
            "publicTranslationController/getTranslations",
            {},
        );
        this.display_translations = this.display_translations.translations;
    }

    async get_module_translations() {
        this.module_translations = await this.call_lnut(
            "translationController/getUserModuleTranslations",
            {
                token: this.token,
            },
        );
        this.module_translations = this.module_translations.translations;
    }

    async get_hwks() {
        const homeworks = await this.call_lnut(
            "assignmentController/getViewableAll",
            {
                token: this.token,
            },
        );
        return homeworks;
    }
}

app = new client_application();
app.main();

  </script>

</body>
</html>
