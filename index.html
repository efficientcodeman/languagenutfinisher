<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <title>Languagenut Helper</title>
  <style>
    /* Modern Font & Base Styles */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

    :root {
      --bg-light: #f4f7f9; --text-light: #1a202c; --primary-light: #3498db; --accent-light: #e0f2fe; --border-light: #d1d5db;
      --bg-dark: #121212; --text-dark: #e2e8f0; --primary-dark: #FFD700; --accent-dark: #2d2d2d; --border-dark: #4a4a4a;
      
      --font-family: 'Inter', sans-serif;
      --transition-speed: 0.3s;
    }

    html.dark { --bg: var(--bg-dark); --text: var(--text-dark); --primary: var(--primary-dark); --accent: var(--accent-dark); --border: var(--border-dark); }
    html.light { --bg: var(--bg-light); --text: var(--text-light); --primary: var(--primary-light); --accent: var(--accent-light); --border: var(--border-light); }

    body {
      font-family: var(--font-family);
      font-size: 1rem;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 1rem;
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    /* Modern UI Elements */
    button {
      font-family: inherit;
      background: var(--primary);
      color: var(--bg);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: bold;
      transition: all var(--transition-speed) ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }
    button:disabled {
      background-color: #555;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    input[type="text"], input[type="password"] {
      display: block;
      width: calc(100% - 1.2rem);
      margin: 0.75rem 0;
      padding: 0.8rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border);
      background: var(--accent);
      color: var(--text);
      transition: all var(--transition-speed) ease;
    }
    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 30%, transparent);
    }

    h2 {
      border-bottom: 2px solid var(--primary);
      padding-bottom: 0.5rem;
      margin-top: 0;
    }

    /* Main Overlay Panels */
    .overlay {
      position: fixed;
      border-radius: 1rem;
      width: 45%; 
      height: 70%;
      background-color: color-mix(in srgb, var(--bg) 95%, transparent);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 1.5rem;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      opacity: 0;
      transform: scale(0.95);
      visibility: hidden;
      transition: opacity var(--transition-speed) ease, transform var(--transition-speed) ease, visibility var(--transition-speed);
    }
    .overlay.visible {
      opacity: 1;
      transform: scale(1);
      visibility: visible;
    }

    /* Checkbox & Controls */
    .checkbox-container { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
    .overflow_container {
      max-height: 16em;
      overflow-y: auto;
      background: var(--accent);
      padding: 1rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border);
      margin-top: 0.5rem;
    }

    /* Progress Bar */
    .progress_bar_container { width: 100%; background-color: var(--accent); border-radius: 0.5rem; height: 1.2rem; margin: 1rem 0; overflow: hidden; border: 1px solid var(--border); }
    .progress_bar {
      width: 0%;
      height: 100%;
      background: var(--primary);
      border-radius: 0.5rem;
      transition: width 0.5s ease-in-out;
    }

    /* Settings & Dialog */
    .settings_button { position: fixed; top: 1rem; right: 1rem; }
    dialog {
      background: var(--accent);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 1.5rem;
      color: var(--text);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
    
    /* Loading Spinner */
    .loader {
        width: 48px; height: 48px; border-radius: 50%;
        display: block; margin: 15px auto;
        position: relative; box-sizing: border-box;
        animation: rotation 1s linear infinite;
    }
    .loader::after, .loader::before {
        content: ''; box-sizing: border-box;
        position: absolute; width: 24px; height: 24px;
        top: 50%; left: 50%; transform: scale(0.5) translate(0, 0);
        background-color: var(--primary); border-radius: 50%;
        animation: anim-loader 1s infinite ease-in-out;
    }
    .loader::before { background-color: color-mix(in srgb, var(--primary) 60%, var(--bg)); transform: scale(0.5) translate(-48px, -48px); }
    @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes anim-loader { 50% { transform: scale(1) translate(-50%, -50%); } }

    /* Theme Switcher */
    .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
    .theme-switch input { display: none; }
    .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
    .slider:before { background-color: white; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(24px); }

    /* Counter */
    .usage-counter { text-align: center; margin-top: 1.5rem; font-size: 0.9rem; opacity: 0.7; }
  </style>
</head>
<body>

  <div id="login" class="overlay">
    <h2>Languagenut Automation</h2>
    <input class="login_field" id="username_input" type="text" placeholder="Username">
    <input class="login_field" id="password_input" type="password" placeholder="Password">
    <button class="login_field" id="login_btn">Log In</button>
    <div class="usage-counter">
      Successfully completed by <b id="usage_count">...</b> users!
    </div>
  </div>

  <div id="hw_panel" class="overlay">
    <h2>Homeworks</h2>
    <div class="checkbox-container">
        <input type="checkbox" id="selectall">
        <label for="selectall">Select all</label>
    </div>
    <div id="hw_container" class="overflow_container"></div>
    <button id="do_hw" style="margin: 1rem 0;">Start Homework ðŸ¤–</button>
  </div>

  <div id="log_panel" style="right: 1rem;" class="overlay">
    <h2>Logs</h2>
    <div class="progress_bar_container">
      <div id="hw_bar" class="progress_bar"></div>
    </div>
    <div id="log_container" class="overflow_container"></div>
  </div>

  <dialog id="settings">
    <p><b>[Esc]</b> to exit</p>
    <label for="speed_slider">Completion Time per Task:</label>
    <input type="range" min="-3" max="18" value="2" id="speed_slider" step="0.1">
    <p>Current speed: <span id="speed_display"></span></p>
    <div style="display: flex; align-items: center; gap: 10px; margin-top: 1rem;">
      <span>Light / Dark Mode:</span>
      <label class="theme-switch">
          <input type="checkbox" id="theme_toggle">
          <span class="slider"></span>
      </label>
    </div>
  </dialog>

  <button id="settings_button" class="settings_button">âš™ Settings</button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // ***************************************************************
    // *** PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE           ***
    // ***************************************************************
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    // ***************************************************************

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const usageCounterRef = db.collection("counters").doc("usage");

    // --- Main Application Logic ---
    let speed = 10000;
    
    // Settings Logic
    document.getElementById("settings_button").addEventListener("click", () => document.getElementById("settings").showModal());
    const speed_input = document.getElementById("speed_slider");
    speed_input.oninput = function () {
      speed = 10 ** this.value;
      document.getElementById("speed_display").innerText = secondsToString(speed);
    };
    speed_input.dispatchEvent(new Event('input')); // Set initial display

    // Theme Toggle
    const themeToggle = document.getElementById("theme_toggle");
    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark');
      document.documentElement.classList.remove('light');
      themeToggle.checked = true;
    } else {
      document.documentElement.classList.add('light');
      document.documentElement.classList.remove('dark');
    }
    themeToggle.addEventListener('change', () => {
        if (themeToggle.checked) {
            document.documentElement.classList.add('dark');
            document.documentElement.classList.remove('light');
            localStorage.setItem('theme', 'dark');
        } else {
            document.documentElement.classList.add('light');
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
        }
    });

    // Utility Functions
    function secondsToString(seconds) {
      seconds = Number(seconds);
      const d = Math.floor(seconds / (3600*24));
      const h = Math.floor(seconds % (3600*24) / 3600);
      const m = Math.floor(seconds % 3600 / 60);
      const s = Math.floor(seconds % 60);
      return `${d}d ${h}h ${m}m ${s}s`;
    }

    async function asyncPool(array, poolSize) {
      const result = []; const pool = [];
      const leavePool = (e) => pool.splice(pool.indexOf(e), 1);
      for (const item of array) {
        const p = Promise.resolve(item());
        result.push(p);
        const e = p.then(() => leavePool(e));
        pool.push(e);
        if (pool.length >= poolSize) await Promise.race(pool);
      }
      return Promise.all(result);
    }
    
    class task_completer {
        constructor(token, task, ietf) {
            // ... (rest of the class is identical to your original code) ...
            this.token = token; this.task = task; this.mode = this.get_task_type(); this.to_language = ietf;
            this.homework_id = task.base[0]; this.catalog_uid = task.catalog_uid ?? task.base[task.base.length - 1];
            this.rel_module_uid = task.rel_module_uid; this.game_uid = task.game_uid; this.game_type = task.type;
        }
        async complete() { const answers = await this.get_data(); await this.send_answers(answers); }
        async get_data() {
            if (this.mode === "sentence") return this.get_sentences(); if (this.mode === "verbs") return this.get_verbs();
            if (this.mode === "phonics") return this.get_phonics(); if (this.mode === "exam") return this.get_exam();
            return this.get_vocabs();
        }
        async send_answers(vocabs) {
            if (!vocabs?.length) return;
            const data = {
                moduleUid: this.catalog_uid, gameUid: this.game_uid, gameType: this.game_type, isTest: true,
                toietf: this.to_language, fromietf: "en-US", score: vocabs.length * 200,
                correctVocabs: vocabs.map((x) => x.uid).join(","), incorrectVocabs: [], homeworkUid: this.homework_id,
                isSentence: this.mode === "sentence", isVerb: this.mode === "verbs", verbUid: this.mode === "verbs" ? this.catalog_uid : "",
                phonicUid: this.mode === "phonics" ? this.catalog_uid : "", sentenceScreenUid: this.mode === "sentence" ? 100 : "",
                sentenceCatalogUid: this.mode === "sentence" ? this.catalog_uid : "", grammarCatalogUid: this.catalog_uid,
                isExam: this.mode === "exam", timeStamp: Math.floor(speed + ((Math.random() - 0.5) / 10) * speed) * 1000,
                vocabNumber: vocabs.length, rel_module_uid: this.task.rel_module_uid, dontStoreStats: true, product: "secondary", token: this.token,
            };
            return this.call_lnut("gameDataController/addGameScore", data);
        }
        async get_verbs() { return (await this.call_lnut("verbTranslationController/getVerbTranslations", { verbUid: this.catalog_uid, toLanguage: this.to_language, fromLanguage: "en-US", token: this.token })).verbTranslations; }
        async get_phonics() { return (await this.call_lnut("phonicsController/getPhonicsData", { phonicCatalogUid: this.catalog_uid, toLanguage: this.to_language, fromLanguage: "en-US", token: this.token })).phonics; }
        async get_sentences() { return (await this.call_lnut("sentenceTranslationController/getSentenceTranslations", { catalogUid: this.catalog_uid, toLanguage: this.to_language, fromLanguage: "en-US", token: this.token })).sentenceTranslations; }
        async get_exam() { return (await this.call_lnut("examTranslationController/getExamTranslationsCorrect", { gameUid: this.game_uid, examUid: this.catalog_uid, toLanguage: this.to_language, fromLanguage: "en-US", token: this.token })).examTranslations; }
        async get_vocabs() { return (await this.call_lnut("vocabTranslationController/getVocabTranslations", { "catalogUid[]": this.catalog_uid, toLanguage: this.to_language, fromLanguage: "en-US", token: this.token })).vocabTranslations; }
        async call_lnut(url, data) { const url_data = new URLSearchParams(data).toString(); return fetch(`https://api.languagenut.com/${url}?${url_data}`).then(r=>r.json()); }
        get_task_type() {
            if (this.task.gameLink.includes("sentenceCatalog")) return "sentence"; if (this.task.gameLink.includes("verbUid")) return "verbs";
            if (this.task.gameLink.includes("phonicCatalogUid")) return "phonics"; if (this.task.gameLink.includes("examUid")) return "exam";
            return "vocabs";
        }
    }

    class client_application {
        constructor() {
            // ... (rest of the class is mostly identical to your original code) ...
            this.username_box = document.getElementById("username_input"); this.password_box = document.getElementById("password_input");
            this.module_translations = []; this.display_translations = []; this.homeworks = [];
        }
        show_box(id) { document.getElementById(id).classList.add("visible"); }
        hide_box(id) { document.getElementById(id).classList.remove("visible"); }
        async call_lnut(url, data) { const url_data = new URLSearchParams(data).toString(); return fetch(`https://api.languagenut.com/${url}?${url_data}`).then(r=>r.json()); }
        main() {
            this.show_box("login");
            usageCounterRef.get().then(doc => {
              if(doc.exists) document.getElementById("usage_count").innerText = doc.data().success_count.toLocaleString();
            });
            document.getElementById("login_btn").onclick = async () => {
              const response = await this.call_lnut("loginController/attemptLogin", { username: this.username_box.value, pass: this.password_box.value });
              this.token = response.newToken;
              if (this.token) this.on_log_in();
            };
        }
        on_log_in() {
            this.hide_box("login"); this.show_box("hw_panel"); this.show_box("log_panel");
            document.getElementById("do_hw").onclick = () => app.do_hwks();
            this.get_module_translations(); this.get_display_translations(); this.display_hwks();
        }
        get_task_name(task) { let name = task.verb_name; if (task.module_translations) name = this.module_translations[task.module_translations[0]]; if (task.module_translation) name = this.module_translations[task.module_translation]; return name; }
        async display_hwks() {
            const homeworks = await this.get_hwks(); const panel = document.getElementById("hw_container");
            panel.innerHTML = ""; this.homeworks = homeworks.homework.reverse();
            const selbutton = document.getElementById("selectall");
            selbutton.onclick = function() { document.getElementsByName("boxcheck").forEach(cb => cb.checked = this.checked); };
            let hw_idx = 0;
            for (const homework of this.homeworks) {
                const { hw_name, hw_display } = this.create_homework_elements(homework, hw_idx);
                panel.appendChild(hw_name); panel.appendChild(hw_display);
                hw_idx++;
            }
        }
        create_homework_elements(homework, hw_idx) {
            const hw_checkbox = document.createElement("input");
            hw_checkbox.type="checkbox"; hw_checkbox.name="boxcheck";
            hw_checkbox.onclick=function(){ 
                const container = document.getElementById(`hw${homework.id}`);
                for (const checkbox of container.querySelectorAll("input[type=checkbox]")) { checkbox.checked = this.checked; }
            };
            const hw_name = document.createElement("span"); hw_name.innerText = homework.name; hw_name.style.display="block"; hw_name.prepend(hw_checkbox);
            const hw_display = document.createElement("div"); hw_display.id = `hw${homework.id}`;
            let idx=0;
            for(const task of homework.tasks){
                const { task_span } = this.create_task_elements(task, hw_idx, idx);
                hw_display.appendChild(task_span); idx++;
            }
            return { hw_name, hw_display };
        }
        create_task_elements(task, hw_idx, idx) {
            const task_checkbox=document.createElement("input");
            task_checkbox.type="checkbox"; task_checkbox.name="boxcheck"; task_checkbox.id=`${hw_idx}-${idx}`;
            const task_display=document.createElement("label");
            task_display.setAttribute('for', task_checkbox.id);
            const percentage = task.gameResults ? task.gameResults.percentage : "-";
            task_display.innerHTML=`&nbsp;${this.display_translations[task.translation]} - ${this.get_task_name(task)} (${percentage}%)`;
            const task_span=document.createElement("span"); task_span.classList.add("task");
            task_span.style.display = 'block';
            task_span.appendChild(task_checkbox); task_span.appendChild(task_display);
            return { task_span };
        }
        async do_hwks() {
            const checkboxes=document.querySelectorAll(".task > input[type=checkbox]:checked");
            const logs=document.getElementById("log_container");
            const doHwButton = document.getElementById("do_hw");
            doHwButton.disabled = true;
            logs.innerHTML=`<div class="loader"></div><p style="text-align:center;">Doing ${checkboxes.length} tasks...</p>`;
            const progress_bar=document.getElementById("hw_bar");
            let progress=0; progress_bar.style.width="0%"; const funcs=[]; let task_id=1;
            for(const c of checkboxes){
                const parts=c.id.split("-"); const task=this.homeworks[parts[0]].tasks[parts[1]];
                const task_doer=new task_completer(this.token,task,this.homeworks[parts[0]].languageCode);
                funcs.push((()=>async(id)=>{
                    const answers=await task_doer.get_data();
                    if(!answers?.length) return;
                    progress++; progress_bar.style.width=`${String((progress/checkboxes.length)*50)}%`;
                    await task_doer.send_answers(answers);
                    progress++; progress_bar.style.width=`${String((progress/checkboxes.length)*100)}%`;
                })(task_id++));
            }
            await asyncPool(funcs,5);
            // Increment usage counter only if tasks were actually done
            if(checkboxes.length > 0) {
              usageCounterRef.update({ success_count: firebase.firestore.FieldValue.increment(1) });
            }
            logs.innerHTML = `<p style="text-align:center; font-weight:bold;">All tasks completed!</p>`
            doHwButton.disabled = false;
            this.display_hwks();
        }
        async get_display_translations() { this.display_translations=(await this.call_lnut("publicTranslationController/getTranslations",{})).translations; }
        async get_module_translations() { this.module_translations=(await this.call_lnut("translationController/getUserModuleTranslations",{token:this.token})).translations; }
        async get_hwks() { return this.call_lnut("assignmentController/getViewableAll",{token:this.token}); }
    }

    const app = new client_application();
    app.main();
  </script>
</body>
</html>
