<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Languagenut Sucks!</title>
  <style>
    body {
      font-family: "Space Mono", monospace;
      font-size: 1rem;
      background-color: #000;
      color: #FFD700;
      margin: 0;
      padding: 0;
    }

    button {
      font-family: inherit;
      background: #FFD700;
      color: #000;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
    }
    button:hover {
      background: #FFC300;
    }

    .login_field {
      display: block;
      margin: 0.5rem 0;
      padding: 0.5rem;
      border-radius: 0.3rem;
      border: 1px solid #FFD700;
      background: #111;
      color: #FFD700;
    }

    .settings_button {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
    }

    .progress_bar {
      padding: 0px;
      width: 0%;
      height: 1rem;
      background-color: #FFD700;
      border-radius: 0.3rem;
    }

    .json_small {
      font-family: "Space Mono", monospace;
      font-size: 0.75rem;
      background: #111;
      padding: 0.25rem;
      border-radius: 0.3rem;
      margin: 0.25rem 0;
    }

    .overlay {
      position: fixed;
      border-radius: 1rem;
      width: 45%; 
      height: 70%;
      background-color: rgba(20, 20, 20, 0.95);
      border: 2px solid #FFD700;
      color: #FFD700;
      visibility: hidden;
      padding: 1rem;
      overflow-y: auto;
    }

    h2 {
      border-bottom: 2px solid #FFD700;
      padding-bottom: 0.3rem;
    }

    .overflow_container {
      max-height: 16em;
      overflow-y: auto;
      background: #111;
      padding: 0.5rem;
      border-radius: 0.5rem;
      margin-top: 0.5rem;
    }

    dialog {
      background: #111;
      border: 2px solid #FFD700;
      border-radius: 0.5rem;
      padding: 1rem;
      color: #FFD700;
    }
  </style>
</head>
<body>
  <div id="login" class="overlay" style="visibility: visible;">
    <h2>Login</h2>
    <input class="login_field" id="username_input" type="text" placeholder="username">
    <input class="login_field" id="password_input" type="password" placeholder="password">
    <button class="login_field" id="login_btn">Log In</button>
  </div>

  <div id="hw_panel" class="overlay">
    <h2>Homeworks</h2>
    <input type="checkbox" id="selectall">
    <label for="selectall">Select all</label>
    <div id="hw_container" class="overflow_container"></div>
    <button id="do_hw" style="margin: 1rem 0;">Start homeworkingðŸ¤–</button>
  </div>

  <div id="log_panel" style="right: 1em;" class="overlay">
    <h2>Logs</h2>
    <div id="hw_bar" class="progress_bar"></div>
    <div id="log_container" class="overflow_container"></div>
  </div>

  <dialog id="settings">
    <p><b>[Esc]</b> to exit</p>
    <label>Select the time you want your homework to appear done in:</label>
    <input type="range" min="-3" max="18" value="2" id="speed_slider" step="0.1">
    <br>
    Current speed: <span id="speed_display"></span>
  </dialog>

  <button id="settings_button" class="settings_button">âš™ Settings</button>

  <script>
    let speed = 10000;
    document.getElementById("settings_button").addEventListener("click", () => {
      document.getElementById("settings").showModal();
    });
    const speed_input = document.getElementById("speed_slider");
    speed_input.oninput = function () {
      speed = 10 ** this.value;
      document.getElementById("speed_display").innerText = secondsToString(speed);
    };

    function secondsToString(seconds) {
      const numyears = Math.floor(seconds / 31536000);
      const numdays = Math.floor((seconds % 31536000) / 86400);
      const numhours = Math.floor(((seconds % 31536000) % 86400) / 3600);
      const numminutes = Math.floor((((seconds % 31536000) % 86400) % 3600) / 60);
      const numseconds = (((seconds % 31536000) % 86400) % 3600) % 60;
      return `${numyears} years ${numdays} days ${numhours} hours ${numminutes} minutes ${numseconds} seconds`;
    }

    function set_checkboxes(node, state) {
      const container = document.getElementById(node);
      for (const checkbox of container.querySelectorAll("input[type=checkbox]")) {
        checkbox.checked = state;
      }
    }

    async function asyncPool(array, poolSize) {
      const result = [];
      const pool = [];
      function leavePool(e) {
        pool.splice(pool.indexOf(e), 1);
      }
      for (const item of array) {
        const p = Promise.resolve(item());
        result.push(p);
        const e = p.then(() => leavePool(e));
        pool.push(e);
        if (pool.length >= poolSize) await Promise.race(pool);
      }
      return Promise.all(result);
    }

    class task_completer {
      constructor(token, task, ietf) {
        this.token = token;
        this.task = task;
        this.mode = this.get_task_type();
        this.to_language = ietf;
        this.homework_id = task.base[0];
        this.catalog_uid = task.catalog_uid ?? task.base[task.base.length - 1];
        this.rel_module_uid = task.rel_module_uid;
        this.game_uid = task.game_uid;
        this.game_type = task.type;
      }
      async complete() {
        const answers = await this.get_data();
        await this.send_answers(answers);
      }
      async get_data() {
        if (this.mode === "sentence") return this.get_sentences();
        if (this.mode === "verbs") return this.get_verbs();
        if (this.mode === "phonics") return this.get_phonics();
        if (this.mode === "exam") return this.get_exam();
        return this.get_vocabs();
      }
      async send_answers(vocabs) {
        if (!vocabs?.length) return;
        const data = {
          moduleUid: this.catalog_uid,
          gameUid: this.game_uid,
          gameType: this.game_type,
          isTest: true,
          toietf: this.to_language,
          fromietf: "en-US",
          score: vocabs.length * 200,
          correctVocabs: vocabs.map((x) => x.uid).join(","),
          incorrectVocabs: [],
          homeworkUid: this.homework_id,
          isSentence: this.mode === "sentence",
          isVerb: this.mode === "verbs",
          verbUid: this.mode === "verbs" ? this.catalog_uid : "",
          phonicUid: this.mode === "phonics" ? this.catalog_uid : "",
          sentenceScreenUid: this.mode === "sentence" ? 100 : "",
          sentenceCatalogUid: this.mode === "sentence" ? this.catalog_uid : "",
          grammarCatalogUid: this.catalog_uid,
          isExam: this.mode === "exam",
          timeStamp: Math.floor(speed + ((Math.random() - 0.5) / 10) * speed) * 1000,
          vocabNumber: vocabs.length,
          rel_module_uid: this.task.rel_module_uid,
          dontStoreStats: true,
          product: "secondary",
          token: this.token,
        };
        return this.call_lnut("gameDataController/addGameScore", data);
      }
      async get_verbs() {
        return (await this.call_lnut("verbTranslationController/getVerbTranslations", {
          verbUid: this.catalog_uid, toLanguage: this.to_language, fromLanguage: "en-US", token: this.token
        })).verbTranslations;
      }
      async get_phonics() {
        return (await this.call_lnut("phonicsController/getPhonicsData", {
          phonicCatalogUid: this.catalog_uid, toLanguage: this.to_language, fromLanguage: "en-US", token: this.token
        })).phonics;
      }
      async get_sentences() {
        return (await this.call_lnut("sentenceTranslationController/getSentenceTranslations", {
          catalogUid: this.catalog_uid, toLanguage: this.to_language, fromLanguage: "en-US", token: this.token
        })).sentenceTranslations;
      }
      async get_exam() {
        return (await this.call_lnut("examTranslationController/getExamTranslationsCorrect", {
          gameUid: this.game_uid, examUid: this.catalog_uid, toLanguage: this.to_language, fromLanguage: "en-US", token: this.token
        })).examTranslations;
      }
      async get_vocabs() {
        return (await this.call_lnut("vocabTranslationController/getVocabTranslations", {
          "catalogUid[]": this.catalog_uid, toLanguage: this.to_language, fromLanguage: "en-US", token: this.token
        })).vocabTranslations;
      }
      async call_lnut(url, data) {
        const url_data = new URLSearchParams(data).toString();
        return fetch(`https://api.languagenut.com/${url}?${url_data}`).then(r=>r.json());
      }
      get_task_type() {
        if (this.task.gameLink.includes("sentenceCatalog")) return "sentence";
        if (this.task.gameLink.includes("verbUid")) return "verbs";
        if (this.task.gameLink.includes("phonicCatalogUid")) return "phonics";
        if (this.task.gameLink.includes("examUid")) return "exam";
        return "vocabs";
      }
    }

    class client_application {
      constructor() {
        this.username_box = document.getElementById("username_input");
        this.password_box = document.getElementById("password_input");
        this.module_translations = [];
        this.display_translations = [];
        this.homeworks = [];
      }
      hide_all() {
        [...document.getElementsByClassName("overlay")].forEach(div => div.style.visibility="hidden");
      }
      show_box(id) { document.getElementById(id).style.visibility="visible"; }
      hide_box(id) { document.getElementById(id).style.visibility="hidden"; }
      async call_lnut(url, data) {
        const url_data = new URLSearchParams(data).toString();
        return fetch(`https://api.languagenut.com/${url}?${url_data}`).then(r=>r.json());
      }
      main() {
        this.show_box("login");
        document.getElementById("login_btn").onclick = async () => {
          const response = await this.call_lnut("loginController/attemptLogin", {
            username: this.username_box.value, pass: this.password_box.value
          });
          this.token = response.newToken;
          if (this.token) this.on_log_in();
        };
      }
      on_log_in() {
        this.hide_box("login");
        this.show_box("hw_panel");
        this.show_box("log_panel");
        document.getElementById("do_hw").onclick = () => { app.do_hwks(); };
        this.get_module_translations();
        this.get_display_translations();
        this.display_hwks();
      }
      get_task_name(task) {
        let name = task.verb_name;
        if (task.module_translations) name = this.module_translations[task.module_translations[0]];
        if (task.module_translation) name = this.module_translations[task.module_translation];
        return name;
      }
      async display_hwks() {
        const homeworks = await this.get_hwks();
        const panel = document.getElementById("hw_container");
        panel.innerHTML = "";
        this.homeworks = homeworks.homework.reverse();
        const selbutton = document.getElementById("selectall");
        selbutton.onclick = function () {
          document.getElementsByName("boxcheck").forEach(cb => cb.checked = this.checked);
        };
        let hw_idx = 0;
        for (const homework of this.homeworks) {
          const { hw_name, hw_display } = this.create_homework_elements(homework, hw_idx);
          panel.appendChild(hw_name);
          panel.appendChild(hw_display);
          hw_idx++;
        }
      }
      create_homework_elements(homework, hw_idx) {
        const hw_checkbox = document.createElement("input");
        hw_checkbox.type="checkbox"; hw_checkbox.name="boxcheck";
        hw_checkbox.onclick=function(){ set_checkboxes(this.parentNode.nextElementSibling.id,this.checked); };
        const hw_name = document.createElement("span");
        hw_name.innerText = homework.name;
        hw_name.style.display="block"; hw_name.prepend(hw_checkbox);
        const hw_display = document.createElement("div");
        hw_display.id = `hw${homework.id}`;
        let idx=0;
        for(const task of homework.tasks){
          const { task_span, task_checkbox, task_display } = this.create_task_elements(task, hw_idx, idx);
          task_span.appendChild(task_checkbox); task_span.appendChild(task_display); task_span.appendChild(document.createElement("br"));
          hw_display.appendChild(task_span); idx++;
        }
        return { hw_name, hw_display };
      }
      create_task_elements(task, hw_idx, idx) {
        const task_checkbox=document.createElement("input");
        task_checkbox.type="checkbox"; task_checkbox.name="boxcheck"; task_checkbox.id=`${hw_idx}-${idx}`;
        const task_display=document.createElement("label");
        task_display.for=task_checkbox.id;
        const percentage = task.gameResults ? task.gameResults.percentage : "-";
        task_display.innerHTML=`${this.display_translations[task.translation]} - ${this.get_task_name(task)} (${percentage}%)`;
        const task_span=document.createElement("span"); task_span.classList.add("task");
        return { task_span, task_checkbox, task_display };
      }
      async do_hwks() {
        const checkboxes=document.querySelectorAll(".task > input[type=checkbox]:checked");
        const logs=document.getElementById("log_container");
        logs.innerHTML=`doing ${checkboxes.length} tasks...<br>`;
        const progress_bar=document.getElementById("hw_bar");
        let progress=0; progress_bar.style.width="0%"; const funcs=[]; let task_id=1;
        for(const c of checkboxes){
          const parts=c.id.split("-");
          const task=this.homeworks[parts[0]].tasks[parts[1]];
          const task_doer=new task_completer(this.token,task,this.homeworks[parts[0]].languageCode);
          funcs.push((()=>async(id)=>{
            const answers=await task_doer.get_data();
            if(!answers?.length) return;
            logs.innerHTML+=`<b>fetched vocabs for task ${id}</b>`;
            logs.innerHTML+=`<div class="json_small">${JSON.stringify(answers)}</div>`;
            progress++; progress_bar.style.width=`${String((progress/checkboxes.length)*50)}%`;
            const result=await task_doer.send_answers(answers);
            logs.innerHTML+=`<b>task ${id} done, scored ${result.score}</b>`;
            logs.innerHTML+=`<div class="json_small">${JSON.stringify(result)}</div>`;
            logs.scrollTop=logs.scrollHeight;
            progress++; progress_bar.style.width=`${String((progress/checkboxes.length)*100)}%`;
          })(task_id++));
        }
        asyncPool(funcs,5).then(()=>this.display_hwks());
      }
      async get_display_translations() {
        this.display_translations=(await this.call_lnut("publicTranslationController/getTranslations",{})).translations;
      }
      async get_module_translations() {
        this.module_translations=(await this.call_lnut("translationController/getUserModuleTranslations",{token:this.token})).translations;
      }
      async get_hwks() {
        return this.call_lnut("assignmentController/getViewableAll",{token:this.token});
      }
    }

    const app = new client_application();
    app.main();
  </script>
</body>
</html>
